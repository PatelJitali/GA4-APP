<div id="store-name" data-store-name="{{ shop.domain | escape }}"></div>
<div id="headerData"></div>

<script>
  document.addEventListener('DOMContentLoaded', async function () {
    const storeNameElement = document.getElementById('store-name');
    const storeName = storeNameElement.getAttribute('data-store-name');

    async function fetchHeaderData() {
      try {
        if (!storeName) {
          console.error('Shop name not found.');
          return;
        }

        console.log('Fetching data for store:', storeName);

        const response = await fetch(`https://b873-122-170-56-160.ngrok-free.app/api/header?storename=${storeName}`, {
          headers: {
            'ngrok-skip-browser-warning': 'true',
            'x-api-key': 'abcdefg',
          },
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const responseData = await response.json();
        console.log('Response data:', responseData);

        if (Array.isArray(responseData) && responseData.length > 0) {
          const headerDataContainer = document.getElementById('headerData');
          headerDataContainer.innerHTML = ''; // Clear previous data

          responseData.forEach((data) => {
            console.log('Header Data Item:', data);

            // Insert body content into headerData div
            if (data.title && data.body) {
              const headerItem = document.createElement('div');
              headerItem.className = 'header-data-item';
              headerItem.innerHTML = `${data.body}`;
              headerDataContainer.appendChild(headerItem);
              console.log('Inserted into body:', data.title, data.body);
            } else {
              console.warn('Title or body is missing for data:', data);
            }

            // Insert header content into the <head> section
            if (data.header) {
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = data.header.trim();
              
              // Safely append each child node to the <head> section
              while (tempDiv.firstChild) {
                document.head.appendChild(tempDiv.firstChild);
              }
              console.log('Inserted into head:', data.header);
            }
          });
        } else {
          console.log('No header data available or invalid format.');
        }
      } catch (error) {
        console.error('Error fetching header data:', error);
      }
    }

    fetchHeaderData();
  });
</script> 
{% schema %}
{
  "name": "GA4 app",
  "target": "head",
  "settings": []
}
{% endschema %}
